<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo 03: Ejercicios Interactivos (Diccionarios)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        surface: { main: '#ffffff', muted: '#f1f5f9', dark: '#0f6cbf' },
                        brand: { primary: '#003c58', accent: '#06717e' },
                        action: { DEFAULT: '#0055ad', hover: '#399be2' },
                        text: { deep: '#1e293b', muted: '#6da8e9', sky: '#6ea2ee' },
                        console: { bg: '#ffffff', text: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Mac Window Buttons */
        .mac-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .mac-red {
            background: #ff5f56;
            border: 1px solid #e0443e;
        }

        .mac-yellow {
            background: #ffbd2e;
            border: 1px solid #dea123;
        }

        .mac-green {
            background: #27c93f;
            border: 1px solid #1aab29;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
    </style>
</head>

<body class="bg-surface-muted h-screen flex flex-col overflow-hidden text-text-deep">

    <!-- Start Screen -->
    <section id="start-screen" class="absolute inset-0 z-50 bg-surface-muted flex items-center justify-center p-12">
        <div class="text-center max-w-4xl animate-[fadeIn_1s_ease-out]">
            <h2 class="text-brand-accent font-bold tracking-[0.2em] uppercase mb-4 text-sm">Unidad 2 - M√≥dulo 03</h2>
            <h1 class="text-6xl font-black text-brand-primary mb-6 leading-tight">Ejercicios Pr√°cticos</h1>
            <p class="text-2xl text-gray-500 font-light mb-12">Domina los diccionarios con <span
                    class="font-bold text-action">retos reales</span></p>
            <div class="h-1 w-24 bg-action mx-auto rounded-full mb-8"></div>
            <p class="text-gray-500 max-w-xl mx-auto mb-12">Pon a prueba tus habilidades resolviendo problemas de
                inventario, usuarios y configuraci√≥n en un entorno simulado.</p>

            <button onclick="startApp()"
                class="bg-brand-primary text-white text-xl font-bold py-4 px-12 rounded-full hover:bg-brand-accent transition-all shadow-xl hover:scale-105 transform flex items-center gap-3 mx-auto">
                Comenzar Misi√≥n üöÄ
            </button>
        </div>
    </section>

    <!-- App Container -->
    <div id="app-container" class="hidden h-screen flex flex-col">

        <!-- Header -->
        <header
            class="bg-surface-main border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-brand-primary rounded-lg flex items-center justify-center text-white font-bold">
                    Py
                </div>
                <h1 class="text-lg font-bold text-brand-primary tracking-tight">M√≥dulo 03: <span
                        class="font-normal text-brand-accent">Ejercicios Pr√°cticos</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="loadMission(0)" id="btn-m0"
                    class="mission-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-all bg-brand-primary text-white shadow-md">1.
                    Inventario</button>
                <button onclick="loadMission(1)" id="btn-m1"
                    class="mission-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-all bg-white text-gray-500 hover:bg-gray-100">2.
                    Pedidos</button>
                <button onclick="loadMission(2)" id="btn-m2"
                    class="mission-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-all bg-white text-gray-500 hover:bg-gray-100">3.
                    Config</button>
                <button onclick="loadMission(3)" id="btn-m3"
                    class="mission-btn px-4 py-1.5 rounded-full text-sm font-semibold transition-all bg-white text-gray-500 hover:bg-gray-100">4.
                    Agenda</button>
            </div>
        </header>

        <!-- Main Workspace -->
        <main class="flex-1 flex gap-6 p-6 overflow-hidden">

            <!-- Left Panel: Context & Requirements -->
            <section class="w-1/3 flex flex-col gap-6 slide-in">
                <!-- Context Card -->
                <div class="bg-surface-main rounded-2xl shadow-lg border border-gray-200 p-6 flex-1 flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-2xl">üìã</span>
                        <h2 class="text-xl font-bold text-brand-primary" id="mission-title">Cargando...</h2>
                    </div>
                    <p class="text-gray-600 mb-6 leading-relaxed" id="mission-desc">...</p>

                    <h3 class="font-bold text-sm uppercase tracking-wider text-gray-400 mb-4">Requisitos del Sistema
                    </h3>
                    <div id="requirements-list" class="space-y-3 flex-1 overflow-y-auto pr-2">
                        <!-- Dynamic Cards Here -->
                    </div>

                    <div id="success-message"
                        class="hidden mt-6 bg-green-50 border border-green-200 rounded-xl p-4 flex items-center gap-3 animate-bounce">
                        <span class="text-2xl">üéâ</span>
                        <div>
                            <p class="font-bold text-green-800">¬°Misi√≥n Completada!</p>
                            <p class="text-sm text-green-600">Has corregido el diccionario perfectamente.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Right Panel: Work Area -->
            <section class="w-2/3 flex flex-col gap-6 slide-in h-full overflow-hidden" style="animation-delay: 0.1s;">

                <!-- Toolbox & Editor -->
                <div
                    class="flex-1 min-h-0 bg-surface-main rounded-2xl shadow-lg border border-gray-200 flex flex-col overflow-hidden">
                    <!-- Mac Header -->
                    <div class="h-10 bg-gray-50 border-b border-gray-200 flex items-center px-4 gap-2">
                        <div class="mac-btn mac-red"></div>
                        <div class="mac-btn mac-yellow"></div>
                        <div class="mac-btn mac-green"></div>
                        <span class="ml-4 text-xs text-gray-400 font-mono">editor_diccionarios.py</span>
                    </div>

                    <div class="flex flex-1 overflow-hidden border-t border-gray-100">
                        <!-- Tools Sidebar -->
                        <div class="w-64 bg-gray-50 border-r border-gray-200 p-3 flex flex-col gap-1.5 overflow-y-auto">
                            <button onclick="setTool('access')"
                                class="tool-btn text-left px-2 py-1.5 rounded-lg hover:bg-white hover:text-action hover:shadow-sm transition-all flex flex-col gap-0 text-gray-600">
                                <div class="flex items-center gap-2 text-xs font-semibold">
                                    <span>üîç</span> Acceder valor
                                </div>
                                <div class="text-[9px] font-mono text-gray-400 ml-5 leading-tight">diccionario["clave"]
                                </div>
                            </button>
                            <button onclick="setTool('modify')"
                                class="tool-btn text-left px-2 py-1.5 rounded-lg hover:bg-white hover:text-action hover:shadow-sm transition-all flex flex-col gap-0 text-gray-600">
                                <div class="flex items-center gap-2 text-xs font-semibold">
                                    <span>‚úèÔ∏è</span> Modificar valor
                                </div>
                                <div class="text-[9px] font-mono text-gray-400 ml-5 leading-tight">dicc["clave"] = valor
                                </div>
                            </button>
                            <button onclick="setTool('add')"
                                class="tool-btn text-left px-2 py-1.5 rounded-lg hover:bg-white hover:text-action hover:shadow-sm transition-all flex flex-col gap-0 text-gray-600">
                                <div class="flex items-center gap-2 text-xs font-semibold">
                                    <span>‚ûï</span> Agregar clave
                                </div>
                                <div class="text-[9px] font-mono text-gray-400 ml-5 leading-tight">dicc["nueva"] = valor
                                </div>
                            </button>
                            <button onclick="setTool('delete')"
                                class="tool-btn text-left px-2 py-1.5 rounded-lg hover:bg-red-50 hover:text-red-500 hover:shadow-sm transition-all flex flex-col gap-0 text-gray-600">
                                <div class="flex items-center gap-2 text-xs font-semibold">
                                    <span>üóëÔ∏è</span> Eliminar clave
                                </div>
                                <div class="text-[9px] font-mono text-gray-400 ml-5 leading-tight">del dicc["clave"]
                                </div>
                            </button>
                            <div class="h-px bg-gray-200 my-0.5"></div>
                            <button onclick="executeLoop()"
                                class="tool-btn text-left px-2 py-1.5 rounded-lg hover:bg-white hover:text-brand-primary hover:shadow-sm transition-all flex flex-col gap-0 text-gray-600">
                                <div class="flex items-center gap-2 text-xs font-semibold">
                                    <span>üîÑ</span> Recorrer / Loop
                                </div>
                                <div class="text-[9px] font-mono text-gray-400 ml-5 leading-tight">for k,v in
                                    dicc.items()
                                </div>
                            </button>
                            <button onclick="executePrint()"
                                class="tool-btn text-left px-2 py-1.5 rounded-lg hover:bg-white hover:text-brand-primary hover:shadow-sm transition-all flex flex-col gap-0 text-gray-600">
                                <div class="flex items-center gap-2 text-xs font-semibold">
                                    <span>üñ®Ô∏è</span> Print Completo
                                </div>
                                <div class="text-[9px] font-mono text-gray-400 ml-5 leading-tight">print(dicc)</div>
                            </button>
                        </div>

                        <!-- Action Console -->
                        <div class="flex-1 p-4 flex flex-col justify-center bg-white relative">
                            <!-- Placeholder State -->
                            <div id="action-placeholder" class="text-center text-gray-400">
                                <div class="text-4xl mb-4">üõ†Ô∏è</div>
                                <p>Selecciona una herramienta para comenzar</p>
                            </div>

                            <!-- Single Operation Form -->
                            <div id="action-form" class="hidden w-full">
                                <h3 id="tool-title"
                                    class="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2">
                                    <span id="tool-icon"></span> <span id="tool-name">...</span>
                                </h3>

                                <div class="bg-gray-50/50 p-4 rounded-2xl border border-gray-100">
                                    <div class="flex flex-col items-center gap-6">
                                        <!-- Inline Form -->
                                        <div class="flex items-center gap-2 font-mono text-sm w-full justify-center">
                                            <div id="field-key" class="flex items-center gap-1">
                                                <span class="text-gray-500 font-bold"><span
                                                        class="var-name">dicc</span>[</span>
                                                <input type="text" id="input-key"
                                                    class="w-32 bg-white border border-gray-300 px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-action text-action font-semibold text-center shadow-sm"
                                                    placeholder='"clave"'>
                                                <span class="text-gray-500 font-bold">]</span>
                                            </div>

                                            <div id="field-val" class="flex items-center gap-2 hidden min-w-0">
                                                <span class="text-gray-400 font-bold">=</span>
                                                <input type="text" id="input-val"
                                                    class="w-48 bg-white border border-gray-300 px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-action text-brand-primary font-semibold shadow-sm text-center"
                                                    placeholder='valor'>
                                            </div>
                                        </div>

                                        <button onclick="runAction()"
                                            class="bg-action text-white font-bold h-11 px-12 rounded-xl hover:bg-action-hover transition-all shadow-md hover:shadow-lg flex items-center justify-center shrink-0 min-w-[200px]">
                                            Ejecutar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Console (Terminal) -->
                <div
                    class="h-[280px] bg-white rounded-2xl shadow-lg border border-gray-200 flex flex-col overflow-hidden shrink-0">
                    <div class="bg-gray-50 p-2 border-b border-gray-200 flex justify-between items-center px-4">
                        <div class="flex items-center gap-2">
                            <div class="mac-btn mac-red"></div>
                            <div class="mac-btn mac-yellow"></div>
                            <div class="mac-btn mac-green"></div>
                            <span class="ml-2 text-xs font-bold text-gray-500 uppercase">Terminal</span>
                        </div>
                        <button onclick="clearConsole()"
                            class="text-[10px] items-center gap-1.5 px-3 py-1 rounded-lg bg-red-50 text-red-500 border border-red-100 font-bold uppercase tracking-wider hover:bg-red-500 hover:text-white transition-all shadow-sm">
                            <span>üóëÔ∏è</span> Limpiar
                        </button>
                    </div>
                    <div id="console-output" class="flex-1 p-4 overflow-y-auto font-mono text-sm bg-white">
                        <div id="terminal-static-header">
                            <div class="text-green-600">Python 3.10.2 Interactive Shell</div>
                            <div class="text-gray-400 text-xs">Type "help", "copyright", "credits" or "license" for more
                                information.</div>
                        </div>
                        <div id="terminal-history" class="space-y-0.5"></div>
                        <div id="terminal-prompt" class="flex items-center gap-1 text-text-deep mt-1">
                            <span>>>></span>
                            <span class="w-1.5 h-4 bg-gray-800 cursor-blink ml-0.5"></span>
                        </div>
                    </div>
                </div>

            </section>
        </main>
    </div> <!-- End App Container -->

    <script>
        function startApp() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
        }

        // --- State Management ---
        const missions = [
            {
                title: "Correcci√≥n de Inventario",
                varName: "inventario",
                desc: "El sistema ha registrado mal el stock. Tu objetivo es corregir el inventario para que coincida exactamente con el reporte f√≠sico.\n\nElimina productos que no existen y ajusta las cantidades err√≥neas.",
                initial: { "laptop": 15, "mouse": 52, "teclado": 30, "monitor": 12, "tablet": 8 },
                conditions: [
                    { type: 'val', key: "laptop", val: 20, msg: "laptop debe ser 20" },
                    { type: 'val', key: "mouse", val: 45, msg: "mouse debe ser 45" },
                    { type: 'eq', key: "teclado", val: 30, msg: "teclado debe ser 30" },
                    { type: 'val', key: "impresora", val: 5, msg: "impresora debe ser 5" },
                    { type: 'missing', key: "monitor", msg: "no debe existir monitor" },
                    { type: 'missing', key: "tablet", msg: "no debe existir tablet" }
                ]
            },
            {
                title: "Sincronizaci√≥n Log√≠stica",
                varName: "pedidos",
                desc: "El sistema log√≠stico tuvo un error al sincronizar pedidos.\nAlgunos pedidos est√°n en estados incorrectos, uno fue cancelado pero sigue activo, y falta registrar un pedido nuevo.\nTu misi√≥n es dejar el sistema exactamente como lo exige el departamento de operaciones.",
                initial: { "P1001": "en_preparacion", "P1002": "enviado", "P1003": "cancelado", "P1004": "enviado", "P_temp": "en_preparacion" },
                conditions: [
                    { type: 'val', key: "P1001", val: "enviado", msg: "P1001 debe ser 'enviado'" },
                    { type: 'eq', key: "P1002", val: "enviado", msg: "P1002 debe ser 'enviado'" },
                    { type: 'val', key: "P1004", val: "entregado", msg: "P1004 debe ser 'entregado'" },
                    { type: 'val', key: "P1005", val: "enviado", msg: "P1005 debe ser 'enviado'" },
                    { type: 'missing', key: "P1003", msg: "eliminar P1003 (cancelado)" },
                    { type: 'missing', key: "P_temp", msg: "eliminar P_temp (temporal)" }
                ]
            },
            {
                title: "Configuraci√≥n del Servidor",
                varName: "config",
                desc: "El servidor principal fue configurado manualmente y presenta inconsistencias.\nAlgunos par√°metros est√°n mal definidos, otros sobran y falta una configuraci√≥n obligatoria.\nTu tarea es dejar el diccionario exactamente como lo exige el entorno de producci√≥n.",
                initial: { "host": "localhost", "port": 3000, "debug": true, "timeout": 120, "test_mode": true },
                conditions: [
                    { type: 'val', key: "host", val: "0.0.0.0", msg: "host debe ser '0.0.0.0'" },
                    { type: 'val', key: "port", val: 8080, msg: "port debe ser 8080" },
                    { type: 'val', key: "debug", val: false, msg: "debug debe ser False" },
                    { type: 'val', key: "timeout", val: 60, msg: "timeout debe ser 60" },
                    { type: 'val', key: "ssl", val: true, msg: "ssl debe ser True" },
                    { type: 'missing', key: "test_mode", msg: "no debe existir test_mode" }
                ]
            },
            {
                title: "Centro M√©dico - Gesti√≥n de Agenda",
                varName: "agenda",
                desc: "Un centro m√©dico actualiz√≥ su agenda diaria.\nUn turno fue cancelado, otro cambi√≥ de horario y se agreg√≥ una nueva cita urgente.",
                initial: {
                    "T100": { "paciente": "Marcela Ruiz", "hora": "09:00", "confirmado": true },
                    "T101": { "paciente": "Diego Castro", "hora": "10:00", "confirmado": false },
                    "T102": { "paciente": "Valentina Cruz", "hora": "11:00", "confirmado": true }
                },
                conditions: [
                    { type: 'nested', key: "T101", subkey: "hora", val: "10:30", msg: "T101: hora debe ser '10:30'" },
                    { type: 'nested', key: "T101", subkey: "confirmado", val: true, msg: "T101: confirmado debe ser True" },
                    { type: 'missing', key: "T102", msg: "T102 no debe existir" },
                    { type: 'exists', key: "T103", msg: "Debe existir T103" },
                    { type: 'nested', key: "T103", subkey: "paciente", val: "Sofia Martinez", msg: "T103: paciente 'Sofia Martinez'" },
                    { type: 'nested', key: "T103", subkey: "hora", val: "12:00", msg: "T103: hora debe ser '12:00'" },
                    { type: 'nested', key: "T103", subkey: "confirmado", val: true, msg: "T103: confirmado debe ser True" }
                ]
            }
        ];

        let currentMissionId = 0;
        let currentDict = {};
        let currentTool = null;

        // --- Init ---
        function loadMission(id) {
            currentMissionId = id;
            // Deep copy initials
            currentDict = JSON.parse(JSON.stringify(missions[id].initial));

            // UI Updates
            document.getElementById('mission-title').textContent = missions[id].title;
            document.getElementById('mission-desc').innerText = missions[id].desc; // innerText preserves \n

            // Dynamic variable names update
            const varName = missions[id].varName;
            document.querySelectorAll('.var-name').forEach(el => el.textContent = varName);

            // Buttons State
            document.querySelectorAll('.mission-btn').forEach((btn, idx) => {
                if (idx === id) {
                    btn.classList.remove('bg-white', 'text-gray-500', 'hover:bg-gray-100');
                    btn.classList.add('bg-brand-primary', 'text-white', 'shadow-md');
                } else {
                    btn.classList.add('bg-white', 'text-gray-500', 'hover:bg-gray-100');
                    btn.classList.remove('bg-brand-primary', 'text-white', 'shadow-md');
                }
            });

            // Reset Console
            document.getElementById('terminal-static-header').classList.remove('hidden');
            document.getElementById('terminal-history').innerHTML = `<div class="text-green-600">Python 3.10.2 System Ready (${varName} loaded)</div>`;

            resetEditor();
            checkConditions(); // Draw initial cards
        }

        function resetEditor() {
            currentTool = null;
            document.getElementById('action-placeholder').classList.remove('hidden');
            document.getElementById('action-form').classList.add('hidden');
        }

        // --- Tool Logic ---
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('action-placeholder').classList.add('hidden');
            document.getElementById('action-form').classList.remove('hidden');

            const title = document.getElementById('tool-title');
            const icon = document.getElementById('tool-icon');
            const name = document.getElementById('tool-name');
            const keyField = document.getElementById('field-key');
            const valField = document.getElementById('field-val');
            const btn = document.querySelector('#action-form button');

            // Reset fields
            document.getElementById('input-key').value = '';
            document.getElementById('input-val').value = '';

            // Nested Hint
            if (currentMissionId === 3 && (tool === 'modify' || tool === 'access')) {
                document.getElementById('input-key').placeholder = '"clave" o padre["hijo"]';
            } else {
                document.getElementById('input-key').placeholder = '"clave"';
            }

            // Highlighting active tool in sidebar
            document.querySelectorAll('.tool-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-action', 'shadow-sm', 'border-l-4', 'border-action');
                // Check if this button corresponds to the selected tool
                if (b.getAttribute('onclick')?.includes(`'${tool}'`)) {
                    b.classList.add('bg-white', 'text-action', 'shadow-sm', 'border-l-4', 'border-action');
                }
            });

            if (tool === 'access') {
                icon.textContent = 'üîç'; name.textContent = 'Acceder Valor';
                keyField.classList.remove('hidden'); valField.classList.add('hidden');
                btn.textContent = 'Obtener Valor';
            } else if (tool === 'modify') {
                icon.textContent = '‚úèÔ∏è'; name.textContent = 'Modificar Valor';
                keyField.classList.remove('hidden'); valField.classList.remove('hidden');
                btn.textContent = 'Actualizar';
            } else if (tool === 'add') {
                icon.textContent = '‚ûï'; name.textContent = 'Agregar Clave';
                keyField.classList.remove('hidden'); valField.classList.remove('hidden');
                btn.textContent = 'Insertar';
            } else if (tool === 'delete') {
                icon.textContent = 'üóëÔ∏è'; name.textContent = 'Eliminar Clave';
                keyField.classList.remove('hidden'); valField.classList.add('hidden');
                btn.textContent = 'Eliminar';
                btn.className = "bg-red-500 text-white font-bold h-11 px-12 rounded-xl hover:bg-red-600 transition-all shadow-md flex items-center justify-center min-w-[200px]";
                return;
            }

            btn.className = "bg-action text-white font-bold h-11 px-12 rounded-xl hover:bg-action-hover transition-all shadow-md flex items-center justify-center min-w-[200px]";
        }

        function parseInput(val) {
            val = val.trim();
            if (val === 'true' || val === 'True') return true;
            if (val === 'false' || val === 'False') return false;
            if (val === '{}') return {};
            if (val === '[]') return [];
            // Number check
            if (!isNaN(val) && val !== '') return Number(val);
            // String check (remove quotes if present)
            if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
                return val.slice(1, -1);
            }
            return val; // Treat as string if clean
        }

        function runAction() {
            if (!currentTool) return;

            const consoleDiv = document.getElementById('console-output');
            const keyRaw = document.getElementById('input-key').value.trim();
            const valRaw = document.getElementById('input-val').value.trim();

            // Clean key (remove quotes if user typed them)
            let key = keyRaw;
            if ((key.startsWith('"') && key.endsWith('"')) || (key.startsWith("'") && key.endsWith("'"))) {
                key = key.slice(1, -1);
            }

            const val = parseInput(valRaw);
            let outputMsg = "";
            let isError = false;

            try {
                // Handling Nested Logic (Simple Dot/Bracket Parsing could be added here, 
                // but for now relying on top-level or specific manual nesting support for Mission 4)

                // Mission 4 Special Handling: Simple Key override or detecting "]["
                // If user types 'server' and mission is nested, it selects the obj.
                // But Prompt says "Modificar valor dentro de subdiccionario".

                // Simple Parser for Nested Keys: e.g. server["port"]
                let targetObj = currentDict;
                let finalKey = key;

                // Extremely basic parser for: parent["child"]
                // regex look for: word["word"] or word['word']
                const nestedMatch = keyRaw.match(/([a-zA-Z0-9_]+)\[["']([a-zA-Z0-9_]+)["']\]/);

                if (nestedMatch) {
                    const parentKey = nestedMatch[1];
                    const childKey = nestedMatch[2];

                    if (targetObj[parentKey] === undefined) throw new Error(`KeyError: '${parentKey}'`);
                    if (typeof targetObj[parentKey] !== 'object') throw new Error(`TypeError: '${parentKey}' is not subscriptable`);

                    if (currentTool === 'modify') {
                        targetObj[parentKey][childKey] = val;
                        outputMsg = `>>> ${missions[currentMissionId].varName}["${parentKey}"]["${childKey}"] = ${JSON.stringify(val)}`;
                    } else if (currentTool === 'add') {
                        targetObj[parentKey][childKey] = val;
                        outputMsg = `>>> ${missions[currentMissionId].varName}["${parentKey}"]["${childKey}"] = ${JSON.stringify(val)}`;
                    } else if (currentTool === 'access') {
                        const res = targetObj[parentKey][childKey];
                        outputMsg = `>>> ${missions[currentMissionId].varName}["${parentKey}"]["${childKey}"]\n${JSON.stringify(res)}`;
                    } else if (currentTool === 'delete') {
                        delete targetObj[parentKey][childKey];
                        outputMsg = `>>> del ${missions[currentMissionId].varName}["${parentKey}"]["${childKey}"]`;
                    }
                } else {
                    // Standard Logic
                    if (currentTool === 'access') {
                        outputMsg = `>>> ${missions[currentMissionId].varName}["${key}"]`;
                        if (currentDict.hasOwnProperty(key)) {
                            outputMsg += `\n${JSON.stringify(currentDict[key], null, 2)}`;
                        } else {
                            throw new Error(`KeyError: '${key}'`);
                        }
                    } else if (currentTool === 'modify') {
                        if (!currentDict.hasOwnProperty(key) && currentMissionId !== 0) {
                        }
                        currentDict[key] = val;
                        outputMsg = `>>> ${missions[currentMissionId].varName}["${key}"] = ${JSON.stringify(val)}`;
                    } else if (currentTool === 'add') {
                        if (currentDict.hasOwnProperty(key)) {
                            outputMsg = `>>> # Key '${key}' already exists, updating value...`;
                        } else {
                            outputMsg = `>>> ${missions[currentMissionId].varName}["${key}"] = ${JSON.stringify(val)}`;
                        }
                        currentDict[key] = val;
                    } else if (currentTool === 'delete') {
                        outputMsg = `>>> del ${missions[currentMissionId].varName}["${key}"]`;
                        if (currentDict.hasOwnProperty(key)) {
                            delete currentDict[key];
                        } else {
                            throw new Error(`KeyError: '${key}'`);
                        }
                    }
                }

            } catch (e) {
                isError = true;
                const vName = missions[currentMissionId].varName;
                outputMsg = `>>> ${currentTool === 'delete' ? 'del ' : ''}${vName}["${key}"]${currentTool === 'modify' ? ' = ...' : ''}\n<span class="text-red-500">${e.message}</span>`;
            }

            const historyDiv = document.getElementById('terminal-history');
            historyDiv.innerHTML += `<div class="whitespace-pre-wrap ${isError ? '' : 'text-text-deep'}">${outputMsg}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;

            checkConditions();
        }

        function executePrint() {
            const consoleDiv = document.getElementById('console-output');
            const historyDiv = document.getElementById('terminal-history');
            const vName = missions[currentMissionId].varName;
            historyDiv.innerHTML += `<div class="text-text-deep whitespace-pre-wrap">>>> print(${vName})\n${JSON.stringify(currentDict, null, 2)}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        async function executeLoop() {
            const consoleDiv = document.getElementById('console-output');
            const historyDiv = document.getElementById('terminal-history');
            const vName = missions[currentMissionId].varName;

            // Header
            const header = document.createElement('div');
            header.className = "text-text-deep mb-1 whitespace-pre-wrap";
            header.innerHTML = `>>> for k, v in ${vName}.items(): print(k, v)\n`;
            historyDiv.appendChild(header);

            const entries = Object.entries(currentDict);
            for (const [k, v] of entries) {
                const line = document.createElement('div');
                line.className = "text-text-deep animate-[fadeIn_0.3s_ease-out] whitespace-pre-wrap";
                line.textContent = `${k} ${JSON.stringify(v)}`;
                historyDiv.appendChild(line);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                await new Promise(r => setTimeout(r, 400));
            }

            // Add spacer after
            historyDiv.innerHTML += '<div class="mb-1"></div>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('terminal-history').innerHTML = '';
            document.getElementById('terminal-static-header').classList.add('hidden');
        }

        // --- Validation Logic ---
        function checkConditions() {
            const mission = missions[currentMissionId];
            const list = document.getElementById('requirements-list');
            list.innerHTML = '';

            let allPassed = true;

            mission.conditions.forEach(req => {
                let passed = false;

                if (req.type === 'val') {
                    // Check strict value equality
                    passed = currentDict[req.key] === req.val;
                } else if (req.type === 'eq') {
                    // Same as val, just semantic difference in definitions
                    passed = currentDict[req.key] === req.val;
                } else if (req.type === 'missing') {
                    passed = !currentDict.hasOwnProperty(req.key);
                } else if (req.type === 'exists') {
                    passed = currentDict.hasOwnProperty(req.key);
                } else if (req.type === 'nested') {
                    // Check nested value
                    try {
                        passed = currentDict[req.key][req.subkey] === req.val;
                    } catch (e) { passed = false; }
                }

                if (!passed) allPassed = false;

                const card = document.createElement('div');
                card.className = `p-3 rounded-lg border flex items-center gap-3 transition-all ${passed ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                card.innerHTML = `
                    <div class="w-2 h-2 rounded-full ${passed ? 'bg-green-500' : 'bg-red-500'}"></div>
                    <span class="text-sm font-medium ${passed ? 'text-green-700' : 'text-red-700'}">${req.msg}</span>
                `;
                list.appendChild(card);
            });

            if (allPassed) {
                document.getElementById('success-message').classList.remove('hidden');
            } else {
                document.getElementById('success-message').classList.add('hidden');
            }
        }

        // Start
        loadMission(0);

    </script>
</body>

</html>